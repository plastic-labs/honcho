name: Unified Tests (Fly Runner)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  start-runner:
    name: Start Fly Runner
    uses: ./.github/workflows/start-fly-runner.yml
    secrets: inherit

  wait-for-runner:
    name: Wait for Runner
    runs-on: ubuntu-latest
    needs: start-runner
    if: needs.start-runner.outputs.runner-ready == 'true'
    steps:
      - run: |
          echo "‚úÖ Runner is ready. Waiting a few seconds before scheduling tests..."
          sleep 5

  unified-tests:
    name: Run Unified Tests
    runs-on: ${{ fromJSON(format('[{0}]', needs.start-runner.outputs.runner-labels)) }}
    needs: [start-runner, wait-for-runner]
    if: needs.start-runner.outputs.runner-ready == 'true'
    timeout-minutes: 90

    env:
      PYTHONUNBUFFERED: "1"
      AUTH_USE_AUTH: "false"
      SENTRY_ENABLED: "false"
      VECTOR_STORE_TYPE: "lancedb"
      DB_CONNECTION_URI: postgresql+psycopg://postgres:postgres@localhost:5433/test_db
      DERIVER_PROVIDER: "anthropic"
      DERIVER_MODEL: "claude-3-haiku-20240307"
      PEER_CARD_PROVIDER: "anthropic"
      PEER_CARD_MODEL: "claude-3-haiku-20240307"
      DIALECTIC_PROVIDER: "anthropic"
      DIALECTIC_MODEL: "claude-3-haiku-20240307"
      DIALECTIC_QUERY_GENERATION_PROVIDER: "anthropic"
      DIALECTIC_QUERY_GENERATION_MODEL: "claude-3-haiku-20240307"
      SUMMARY_PROVIDER: "anthropic"
      SUMMARY_MODEL: "claude-3-haiku-20240307"
      DREAM_PROVIDER: "anthropic"
      DREAM_MODEL: "claude-3-haiku-20240307"
      LLM_ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Verify Docker is available
        run: docker info

      - name: Start PostgreSQL database
        run: |
          # Clean up any existing postgres container from previous runs
          docker rm -f postgres 2>/dev/null || true

          docker run -d \
            --name postgres \
            -e POSTGRES_DB=test_db \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -p 5433:5432 \
            pgvector/pgvector:pg15

          # Wait for database to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec postgres pg_isready -U postgres; then
              echo "‚úÖ PostgreSQL is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Verify uv and Python
        run: |
          uv --version
          python3.12 --version
          which python3.12

      - name: Install the project
        run: uv sync --all-extras --dev

      - name: Run unified tests
        run: uv run python -m tests.unified.run

  cleanup-machine:
    name: Cleanup Fly Machine and Runner
    runs-on: ubuntu-latest
    needs: [start-runner, unified-tests]
    if: always() && needs.start-runner.outputs.machine-id != ''
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_TESTING }}
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN_ACTIONS }}
      FLY_RUNNER_APP: ivysaur
    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Cleanup fly machine
        run: |
          set -euo pipefail
          MACHINE_ID="${{ needs.start-runner.outputs.machine-id }}"
          if [ -z "$MACHINE_ID" ]; then
            echo "No machine ID provided, skipping Fly cleanup."
            exit 0
          fi

          echo "üßπ Cleaning up machine: $MACHINE_ID"
          flyctl machines stop "$MACHINE_ID" -a "$FLY_RUNNER_APP" || echo "Machine may already be stopped"
          flyctl machines destroy "$MACHINE_ID" -a "$FLY_RUNNER_APP" --force || echo "Failed to destroy machine"

      - name: Cleanup GitHub runner
        run: |
          set -euo pipefail
          RUNNER_NAME="${{ needs.start-runner.outputs.runner-name }}"
          FALLBACK_LABEL="${{ github.run_id }}"

          echo "üóëÔ∏è Cleaning up GitHub runner (name: ${RUNNER_NAME:-unknown}, label: ${FALLBACK_LABEL})"

          RUNNERS_RESPONSE=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners")

          if echo "$RUNNERS_RESPONSE" | grep -q '"message"'; then
            echo "‚ö†Ô∏è Failed to fetch runners: $(echo "$RUNNERS_RESPONSE" | jq -r '.message')"
            exit 0
          fi

          RUNNER_ID=""¬†
          if [ -n "$RUNNER_NAME" ]; then
            RUNNER_ID=$(echo "$RUNNERS_RESPONSE" | jq -r --arg name "$RUNNER_NAME" '.runners[]? | select(.name == $name) | .id')
          fi

          if [ -z "$RUNNER_ID" ]; then
            RUNNER_ID=$(echo "$RUNNERS_RESPONSE" | jq -r --arg label "$FALLBACK_LABEL" '.runners[]? | select([.labels[].name] | index($label)) | .id' | head -n 1)
          fi

          if [ -z "$RUNNER_ID" ] || [ "$RUNNER_ID" = "null" ]; then
            echo "‚ö†Ô∏è Runner not found, nothing to delete."
            exit 0
          fi

          DELETE_RESPONSE=$(curl -s -w "%{http_code}" \
            -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners/$RUNNER_ID")

          HTTP_CODE="${DELETE_RESPONSE: -3}"
          if [ "$HTTP_CODE" = "204" ]; then
            echo "‚úÖ Successfully deleted runner."
          else
            echo "‚ö†Ô∏è Failed to delete runner. HTTP code: $HTTP_CODE"
            echo "Response: ${DELETE_RESPONSE%???}"
          fi
